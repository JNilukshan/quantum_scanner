<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entrance Board</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#9aa7bf;
    --accent:#4ade80; /* green */
    --accent-alt:#60a5fa; /* blue */
    --danger:#fb7185;
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071028 0%, #0b1930 100%);color:#e6eef8}
  .container{
    display:flex;
    align-items:center;
    justify-content:center;
    height:100vh;
    padding:2rem;
    box-sizing:border-box;
  }
  .card{
    width:clamp(320px, 80vw, 1100px);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    padding:2rem;
    display:grid;
    gap:1rem;
    grid-template-columns: 220px 1fr;
    align-items:center;
    backdrop-filter: blur(6px);
  }
  /* Responsive */
  @media (max-width:720px){
    .card{grid-template-columns:1fr; padding:1.25rem;}
  }

  /* Image circle */
  .avatar {
    width:180px;
    height:180px;
    border-radius:999px;
    background:linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    box-shadow: 0 6px 18px rgba(2,6,23,0.6);
    transition: transform 300ms ease, box-shadow 300ms ease;
    border: 4px solid rgba(255,255,255,0.03);
  }
  .avatar img{width:100%; height:100%; object-fit:cover; display:block;}
  .avatar.placeholder{
    font-size:72px; color:var(--muted); font-weight:600;
  }

  .meta {
    padding-left:1rem;
  }
  h1 { margin:0; font-weight:700; font-size:2.2rem; letter-spacing:-0.6px }
  .muted { color:var(--muted); font-size:0.95rem; margin-top:0.25rem; }

  .row { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; margin-top:1rem; }
  .pill { background: rgba(255,255,255,0.03); padding:0.45rem 0.75rem; border-radius:999px; font-weight:600; font-size:0.95rem; color:#dbe8ff; }
  .dept { color:var(--muted); font-weight:600; font-size:0.95rem }

  /* attendance badge */
  .attendance {
    margin-top:1.25rem;
    display:inline-flex;
    align-items:center;
    gap:0.6rem;
    padding:0.6rem 0.9rem;
    border-radius:999px;
    font-weight:700;
    letter-spacing:0.2px;
    transition: transform 250ms ease, background 250ms ease;
  }
  .attendance .dot{
    width:12px; height:12px; border-radius:999px; background:var(--accent);
    box-shadow: 0 0 12px rgba(74,222,128,0.18);
  }

  /* highlight for arrived vs not */
  .attendance.arrived { background: rgba(74,222,128,0.12); color:var(--accent); }
  .attendance.not-arrived { background: rgba(253,186,116,0.06); color:#f59e0b; }
  .attendance.unknown { background: rgba(255,255,255,0.03); color:var(--muted); }

  /* animation */
  .fade-in {
    animation: fadein 360ms ease both;
  }
  @keyframes fadein {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* top-right small controls (for demo only) */
  .controls {
    position:fixed; right:16px; top:16px;
    display:flex; gap:8px; align-items:center;
  }
  .controls input{ padding:10px 12px; border-radius:8px; border: none; outline:none; width:220px; font-size:0.95rem; }
  .controls button{ padding:10px 14px; border-radius:8px; border:none; background:var(--accent-alt); color:white; font-weight:700; cursor:pointer; }

  /* user not found screen */
  .notfound{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1rem; text-align:center;
  }
  .notfound h2{ color:#ffdede; font-size:1.6rem; margin:0 }
  .notfound p{ color:var(--muted); margin:0 }
</style>
</head>
<body>
<div class="controls" aria-hidden="true">
  <!-- Demo input to simulate a mobile scan; in real setup mobile POSTs to API directly -->
  <input id="hashInput" placeholder="Paste emp_hash (simulate scan)" />
  <button id="scanBtn">Scan</button>
</div>

<div class="container">
  <div class="card" id="board">
    <!-- Left: avatar -->
    <div style="display:flex; align-items:center; justify-content:center;">
      <div id="avatar" class="avatar placeholder">?</div>
    </div>

    <!-- Right: metadata -->
    <div class="meta">
      <div id="content">
        <h1 id="name">Welcome</h1>
        <div class="muted" id="subtitle">Scan your QR to check in</div>

        <div class="row" style="margin-top:1.25rem;">
          <div class="pill" id="emp_no">‚Äî</div>
          <div class="dept" id="department">‚Äî</div>
          <div class="pill" id="participant_type">‚Äî</div>
        </div>

        <div id="attendanceWrap">
          <div class="attendance unknown" id="attendanceBadge"><span class="dot" style="display:none"></span><span id="attendanceText">Not scanned</span></div>
        </div>
      </div>

      <!-- optional extra small info -->
      <div style="margin-top:1.2rem; color:var(--muted); font-size:0.9rem;">
        <span id="location">‚Äî</span> ‚Ä¢ <span id="timestamp">‚Äî</span>
      </div>
    </div>
  </div>
</div>

<!-- Socket.IO CDN -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // Config - change as needed
  const API_BASE = (window.location.hostname === 'localhost') ? 'http://localhost:5000' : ''; // set server origin if different
  const SCAN_ENDPOINT = API_BASE + '/api/scan';
  const API_KEY = ''; // If you use API key, set here or fetch from secure place

  const avatarEl = document.getElementById('avatar');
  const nameEl = document.getElementById('name');
  const subtitleEl = document.getElementById('subtitle');
  const empNoEl = document.getElementById('emp_no');
  const deptEl = document.getElementById('department');
  const partEl = document.getElementById('participant_type');
  const attendanceBadge = document.getElementById('attendanceBadge');
  const attendanceText = document.getElementById('attendanceText');
  const locationEl = document.getElementById('location');
  const timestampEl = document.getElementById('timestamp');
  const contentEl = document.getElementById('content');

  // Initialize Socket.IO
  const socket = io(API_BASE);
  
  socket.on('connect', function() {
    console.log('Connected to server');
    showStatus('Connected', 'Ready to receive scans');
  });
  
  socket.on('disconnect', function() {
    console.log('Disconnected from server');
    showStatus('Disconnected', 'Connection lost');
  });
  
  socket.on('status', function(data) {
    console.log('Status:', data.message);
  });
  
  // Listen for QR scans from mobile app
  socket.on('qr_scanned', function(scanData) {
    console.log('QR scan received:', scanData);
    handleMobileScan(scanData);
  });

  function showStatus(status, message) {
    nameEl.textContent = status;
    subtitleEl.textContent = message;
  }

  function handleMobileScan(scanData) {
    // Show scan animation or effect
    avatarEl.style.transform = 'scale(1.1)';
    setTimeout(() => {
      avatarEl.style.transform = 'scale(1)';
    }, 300);

    if (scanData.employee) {
      // Show employee data if it's an employee QR code
      showEmployee({employee: scanData.employee});
    } else {
      // Show generic QR data
      showQRData(scanData);
    }
  }

  function showQRData(scanData) {
    // Display for non-employee QR codes
    avatarEl.className = 'avatar placeholder fade-in';
    
    // Set icon based on data type
    switch(scanData.data_type) {
      case 'URL':
        avatarEl.innerHTML = 'üåê';
        break;
      case 'Email':
        avatarEl.innerHTML = 'üìß';
        break;
      case 'Phone':
        avatarEl.innerHTML = 'üìû';
        break;
      default:
        avatarEl.innerHTML = 'üìã';
    }
    
    nameEl.textContent = `${scanData.data_type} Scanned`;
    subtitleEl.textContent = scanData.qr_data.length > 50 ? 
      scanData.qr_data.substring(0, 50) + '...' : scanData.qr_data;
    
    empNoEl.textContent = scanData.device_id;
    deptEl.textContent = scanData.data_type;
    partEl.textContent = 'Mobile App';
    
    attendanceBadge.className = 'attendance arrived fade-in';
    attendanceText.textContent = 'Scanned';
    attendanceBadge.querySelector('.dot') && (attendanceBadge.querySelector('.dot').style.display = 'inline-block');
    
    locationEl.textContent = 'Mobile Device';
    timestampEl.textContent = new Date(scanData.timestamp).toLocaleString();
  }

  function showNotFound() {
    avatarEl.className = 'avatar placeholder fade-in';
    avatarEl.innerHTML = 'üôÅ';
    nameEl.textContent = 'User not recognized';
    subtitleEl.textContent = 'Please contact reception';
    empNoEl.textContent = '‚Äî';
    deptEl.textContent = '‚Äî';
    partEl.textContent = '‚Äî';
    attendanceBadge.className = 'attendance not-arrived fade-in';
    attendanceText.textContent = 'Not recognized';
    locationEl.textContent = '‚Äî';
    timestampEl.textContent = new Date().toLocaleString();
  }

  function showEmployee(data) {
    const e = data.employee;
    // image handling
    if (e.image_url) {
      avatarEl.className = 'avatar fade-in';
      avatarEl.innerHTML = `<img src="${e.image_url}" alt="${e.name}" />`;
    } else {
      avatarEl.className = 'avatar placeholder fade-in';
      avatarEl.textContent = (e.name || 'U').split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase();
    }

    nameEl.textContent = e.name || 'Unknown';
    subtitleEl.textContent = e.department || '';
    empNoEl.textContent = e.emp_no || '‚Äî';
    deptEl.textContent = e.department || '‚Äî';
    partEl.textContent = e.participant_type || '‚Äî';
    locationEl.textContent = e.location || '‚Äî';
    timestampEl.textContent = new Date().toLocaleString();

    // Attendance styling (map your DB values to UI)
    const att = (e.attendance || '').toLowerCase();
    if (att.includes('check') || att.includes('arriv') || att.includes('in')) {
      attendanceBadge.className = 'attendance arrived fade-in';
      attendanceText.textContent = 'Checked in';
      attendanceBadge.querySelector('.dot') && (attendanceBadge.querySelector('.dot').style.display = 'inline-block');
    } else if (att.includes('out') || att.includes('not')) {
      attendanceBadge.className = 'attendance not-arrived fade-in';
      attendanceText.textContent = e.attendance || 'Not arrived';
      attendanceBadge.querySelector('.dot') && (attendanceBadge.querySelector('.dot').style.display = 'none');
    } else {
      attendanceBadge.className = 'attendance unknown fade-in';
      attendanceText.textContent = e.attendance || 'Unknown';
      attendanceBadge.querySelector('.dot') && (attendanceBadge.querySelector('.dot').style.display = 'none');
    }
  }

  async function callScan(emp_hash) {
    try {
      // show loading / subtle UI change
      nameEl.textContent = 'Scanning...';
      subtitleEl.textContent = '';

      const payload = { emp_hash };
      const headers = { "Content-Type": "application/json" };
      if (API_KEY) headers["X-API-KEY"] = API_KEY;

      const resp = await fetch(SCAN_ENDPOINT, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
        credentials: 'omit'
      });

      if (!resp.ok) {
        if (resp.status === 404) {
          showNotFound();
          return;
        }
        // Other errors
        nameEl.textContent = 'Server error';
        subtitleEl.textContent = 'Could not retrieve data';
        return;
      }

      const data = await resp.json();
      if (data.success && data.employee) {
        showEmployee(data);
      } else {
        showNotFound();
      }
    } catch (err) {
      console.error(err);
      nameEl.textContent = 'Network error';
      subtitleEl.textContent = 'Check server connection';
    }
  }

  // Demo controls
  document.getElementById('scanBtn').addEventListener('click', () => {
    const val = document.getElementById('hashInput').value.trim();
    if (!val) {
      nameEl.textContent = 'Enter emp_hash to simulate';
      return;
    }
    callScan(val);
  });

  // Add some CSS transitions for smooth animations
  avatarEl.style.transition = 'transform 0.3s ease';
</script>
</body>
</html>
